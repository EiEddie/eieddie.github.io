<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Mahony 非线性互补滤波器# Mahony 互补滤波算法是一种成熟的姿态估计算法, 旨在融合多种传感器的数据来估计最优姿态. 本篇文章将介绍这一滤波器的数学推导与应用.
在第一章中, 我们先约定文章中使用的符号, 并对不同传感器的数据进行建模; 第二章, 从刚体的运动学入手, 使用李群与李代数作为分析工具; 第三章介绍优化姿态的方法, 并引出两个滤波器: 直接互补滤波器 (Direct Complementary Filter) 与被动互补滤波器 (Passive Complementary Filter); 第四章在被动互补滤波器的基础上讨论更方便的向量版本, 称为显式互补滤波器 (Explicit Complementary Filter); 在第五章中, 我们进一步讨论显式互补滤波器的四元数版本. 本文将不涉及系统的 Lyapunov 稳定性分析.
本文主要编译自 Mahony 等人发表在 IEEE Transactions on Automatic Control 上的论文1.
符号约定与传感器数据建模# 文章中 $[\cdot]_\times$ 表示向量的外积矩阵, 它是一个反对称矩阵. 使用 $\dot{R} := \partial R := \frac{\mathrm{d} R}{\mathrm{d} t}$ 表示求导. 线性函数 $\mathrm{vex}(\cdot)$ 表示将李代数, 即反对称矩阵转为向量; 类似地, 我们有 $\mathrm{wedge}(\cdot)$ 将向量转为李代数. 另外, 约定线性函数 $\mathbb{P}_a(A) := \frac{1}{2} (A - A^T)$ 将矩阵映射为一个反对称矩阵.
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/docs/0db9ab/">
  <meta property="og:site_name" content="EiEddie&#39;s Mind">
  <meta property="og:title" content="Mahony 非线性互补滤波器">
  <meta property="og:description" content="Mahony 非线性互补滤波器# Mahony 互补滤波算法是一种成熟的姿态估计算法, 旨在融合多种传感器的数据来估计最优姿态. 本篇文章将介绍这一滤波器的数学推导与应用.
在第一章中, 我们先约定文章中使用的符号, 并对不同传感器的数据进行建模; 第二章, 从刚体的运动学入手, 使用李群与李代数作为分析工具; 第三章介绍优化姿态的方法, 并引出两个滤波器: 直接互补滤波器 (Direct Complementary Filter) 与被动互补滤波器 (Passive Complementary Filter); 第四章在被动互补滤波器的基础上讨论更方便的向量版本, 称为显式互补滤波器 (Explicit Complementary Filter); 在第五章中, 我们进一步讨论显式互补滤波器的四元数版本. 本文将不涉及系统的 Lyapunov 稳定性分析.
本文主要编译自 Mahony 等人发表在 IEEE Transactions on Automatic Control 上的论文1.
符号约定与传感器数据建模# 文章中 $[\cdot]_\times$ 表示向量的外积矩阵, 它是一个反对称矩阵. 使用 $\dot{R} := \partial R := \frac{\mathrm{d} R}{\mathrm{d} t}$ 表示求导. 线性函数 $\mathrm{vex}(\cdot)$ 表示将李代数, 即反对称矩阵转为向量; 类似地, 我们有 $\mathrm{wedge}(\cdot)$ 将向量转为李代数. 另外, 约定线性函数 $\mathbb{P}_a(A) := \frac{1}{2} (A - A^T)$ 将矩阵映射为一个反对称矩阵.">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:published_time" content="2025-06-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-06-30T00:00:00+00:00">
    <meta property="article:tag" content="数学">
    <meta property="article:tag" content="控制">


  <meta itemprop="name" content="Mahony 非线性互补滤波器">
  <meta itemprop="description" content="Mahony 非线性互补滤波器# Mahony 互补滤波算法是一种成熟的姿态估计算法, 旨在融合多种传感器的数据来估计最优姿态. 本篇文章将介绍这一滤波器的数学推导与应用.
在第一章中, 我们先约定文章中使用的符号, 并对不同传感器的数据进行建模; 第二章, 从刚体的运动学入手, 使用李群与李代数作为分析工具; 第三章介绍优化姿态的方法, 并引出两个滤波器: 直接互补滤波器 (Direct Complementary Filter) 与被动互补滤波器 (Passive Complementary Filter); 第四章在被动互补滤波器的基础上讨论更方便的向量版本, 称为显式互补滤波器 (Explicit Complementary Filter); 在第五章中, 我们进一步讨论显式互补滤波器的四元数版本. 本文将不涉及系统的 Lyapunov 稳定性分析.
本文主要编译自 Mahony 等人发表在 IEEE Transactions on Automatic Control 上的论文1.
符号约定与传感器数据建模# 文章中 $[\cdot]_\times$ 表示向量的外积矩阵, 它是一个反对称矩阵. 使用 $\dot{R} := \partial R := \frac{\mathrm{d} R}{\mathrm{d} t}$ 表示求导. 线性函数 $\mathrm{vex}(\cdot)$ 表示将李代数, 即反对称矩阵转为向量; 类似地, 我们有 $\mathrm{wedge}(\cdot)$ 将向量转为李代数. 另外, 约定线性函数 $\mathbb{P}_a(A) := \frac{1}{2} (A - A^T)$ 将矩阵映射为一个反对称矩阵.">
  <meta itemprop="datePublished" content="2025-06-30T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-06-30T00:00:00+00:00">
  <meta itemprop="wordCount" content="1242">
  <meta itemprop="keywords" content="数学,控制">

<title>Mahony 非线性互补滤波器 | EiEddie&#39;s Mind</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="http://localhost:1313/docs/0db9ab/">
<link rel="stylesheet" href="/book.min.11270e190e6f52db54f0e3a0a4a7faab75b77e0e50bcbc00224375a7e38fdd7d.css" integrity="sha256-EScOGQ5vUttU8OOgpKf6q3W3fg5QvLwAIkN1p&#43;OP3X0=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/en.search.min.21d1ebbc72a59a8b382d695863231a987f94357587d503914fa3d410640407bc.js" integrity="sha256-IdHrvHKlmos4LWlYYyMamH&#43;UNXWH1QORT6PUEGQEB7w=" crossorigin="anonymous"></script>



  


<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(', '\\)']],
      displayMath: [['$$', '$$']]
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"
  async>
</script>



</head>
<body dir="ltr" class="book-kind-page book-type-docs">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>EiEddie&#39;s Mind</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="Search"
    aria-label="Search"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>













  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/c8b164/" class="">
      为 Hugo 添加数学支持</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ce801b/" class="">
      使用 Hugo 搭建静态站点</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/af2d30/" class="">
      带有单位的物理计算</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/414ecc/" class="">
      量子力学中的角动量</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/d6a126/" class="">
      若尔当标准型</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cb7535/" class="">
      可交换的线性变换</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/7e6d58/" class="">
      密度流体的动态模拟</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/5ff52f/" class="">
      从中科大回来的时候我母亲就预言了我的今天</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/c3e9f1/" class="">
      ESP32 环境配置与开发</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/0db9ab/" class="active">
      Mahony 非线性互补滤波器</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/243281/" class="">
      异步非阻塞串口数据接收</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/2e89ba/" class="">
      约定式提交</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/b9a0d6/" class="">
      `git` 子模块</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/66247c/" class="">
      关于知识库框架结构的一些想法</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/4da923/" class="">
      Git Tips</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/8cbed4/" class="">
      Windows 下的现代 C/C&#43;&#43; 开发环境配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/2e7eba/" class="">
      在移动介质中安装操作系统</a>
  

        </li>
      
    
  </ul>













</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>Mahony 非线性互补滤波器</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#符号约定与传感器数据建模">符号约定与传感器数据建模</a>
      <ul>
        <li><a href="#陀螺仪">陀螺仪</a></li>
        <li><a href="#加速度计">加速度计</a></li>
        <li><a href="#磁力计">磁力计</a></li>
      </ul>
    </li>
    <li><a href="#刚体运动学">刚体运动学</a></li>
    <li><a href="#姿态估计">姿态估计</a></li>
    <li><a href="#显式互补滤波器">显式互补滤波器</a></li>
    <li><a href="#四元数滤波运动学">四元数滤波运动学</a></li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="mahony-非线性互补滤波器">Mahony 非线性互补滤波器<a class="anchor" href="#mahony-%e9%9d%9e%e7%ba%bf%e6%80%a7%e4%ba%92%e8%a1%a5%e6%bb%a4%e6%b3%a2%e5%99%a8">#</a></h1>
<p>Mahony 互补滤波算法是一种成熟的姿态估计算法, 旨在融合多种传感器的数据来估计最优姿态. 本篇文章将介绍这一滤波器的数学推导与应用.</p>
<p>在第一章中, 我们先约定文章中使用的符号, 并对不同传感器的数据进行建模;
第二章, 从刚体的运动学入手, 使用李群与李代数作为分析工具;
第三章介绍优化姿态的方法, 并引出两个滤波器: <strong>直接互补滤波器</strong> (<strong>Direct Complementary Filter</strong>) 与<strong>被动互补滤波器</strong> (<strong>Passive Complementary Filter</strong>);
第四章在被动互补滤波器的基础上讨论更方便的向量版本, 称为<strong>显式互补滤波器</strong> (<strong>Explicit Complementary Filter</strong>);
在第五章中, 我们进一步讨论显式互补滤波器的四元数版本.
本文将不涉及系统的 Lyapunov 稳定性分析.</p>
<p>本文主要编译自 Mahony 等人发表在 <em>IEEE Transactions on Automatic Control</em> 上的论文<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<h2 id="符号约定与传感器数据建模">符号约定与传感器数据建模<a class="anchor" href="#%e7%ac%a6%e5%8f%b7%e7%ba%a6%e5%ae%9a%e4%b8%8e%e4%bc%a0%e6%84%9f%e5%99%a8%e6%95%b0%e6%8d%ae%e5%bb%ba%e6%a8%a1">#</a></h2>
<p>文章中 $[\cdot]_\times$ 表示向量的外积矩阵, 它是一个反对称矩阵.
使用 $\dot{R} := \partial R := \frac{\mathrm{d} R}{\mathrm{d} t}$ 表示求导.
线性函数 $\mathrm{vex}(\cdot)$ 表示将李代数, 即反对称矩阵转为向量;
类似地, 我们有 $\mathrm{wedge}(\cdot)$ 将向量转为李代数.
另外, 约定线性函数 $\mathbb{P}_a(A) := \frac{1}{2} (A - A^T)$ 将矩阵映射为一个反对称矩阵.</p>
<p>自然地约定两个参考坐标系, ${A}$ 表示世界全局坐标系, ${B}$ 表示固连于刚体上的局部左标系;
另外, 我们还约定 ${E}$ 为估计后的局部坐标系, 它被表示为与 ${B}$ 固定于同一点, 但是姿态稍有变化.</p>
<p>矩阵 $\sideset{_A^B}{}R$ 表示从 ${A}$ 向 ${B}$ 的坐标变换, 同时也是 ${B}$ 在 ${A}$ 中的姿态.
我们也为其中的几个代表另取简洁且富有深意的代号:
原始位姿 $R_y := \sideset{_B^A}{}R$; 估计后的位姿 $\hat{R} := \sideset{_E^A}{}R$ 以及描述 ${B}$ 与 ${E}$ 的误差 $\tilde{R} := \sideset{_B^E}{}R = \hat{R}^T R_y$.
因为三个参考坐标系都是归一化正交右手坐标系, 因此上述矩阵皆为正交矩阵, 且行列式为正.</p>
<h3 id="陀螺仪">陀螺仪<a class="anchor" href="#%e9%99%80%e8%9e%ba%e4%bb%aa">#</a></h3>
<p>陀螺仪测量的是在 ${B}$ 中的, 刚体绕过测量中心的一轴的角速度 $\mathbf{\Omega}^y$, 带有偏置 $\mathbf{b}$ 与噪声 $\mathbf{\mu}$.
测量值与真实值 $\mathbf{\Omega} \in {B}$ 的关系可以表示为
</p>
$$\mathbf{\Omega}^y = \mathbf{\Omega} + \mathbf{b} + \mathbf{\mu}$$<h3 id="加速度计">加速度计<a class="anchor" href="#%e5%8a%a0%e9%80%9f%e5%ba%a6%e8%ae%a1">#</a></h3>
<p>加速度计测量加速度方向, 同样带有偏置 $\mathbf{b}_a$ 和噪声 $\mathbf{\mu}_a$. 因为受重力的缘故, 加速度计测量的始终是比力 (Specific Force), 即刚体的绝对加速度与重力加速度之和.
于是测量得到的 ${B}$ 中的加速度 $\mathbf{a}$ 可以表示为
</p>
$$\mathbf{a} = R_y^T (\sideset{^A}{}{\dot{\mathbf{v}}} - \mathbf{g}_0) + \mathbf{b}_a + \mathbf{\mu}_a$$<h3 id="磁力计">磁力计<a class="anchor" href="#%e7%a3%81%e5%8a%9b%e8%ae%a1">#</a></h3>
<p>同样地, 有偏置 $\mathbf{B}_m$ 与噪声 $\mathbf{\mu}_b$,
测量值 $\mathbf{m} \in {B}$ 与真实值 $\sideset{^A}{}{\mathbf{m}}$ 的关系为
</p>
$$\mathbf{m} = R_y^T \sideset{^A}{}{\mathbf{m}} + \mathbf{B}_m + \mathbf{\mu}_b$$<h2 id="刚体运动学">刚体运动学<a class="anchor" href="#%e5%88%9a%e4%bd%93%e8%bf%90%e5%8a%a8%e5%ad%a6">#</a></h2>
<p>我们知道刚体旋转有 $R = \mathrm{e}^{[\Omega]<em>\times t}$,
于是 $\dot{R} = \partial \mathrm{e}^{[\Omega]</em>\times t} = \mathrm{e}^{[\Omega]<em>\times t} [\Omega]</em>\times = R [\Omega]_\times$.</p>
<p>进一步地, 因为 $[R \Omega]<em>\times = R [\Omega]</em>\times R^T$, 有
</p>
$$\dot{R} = [R \Omega]_\times R$$<h2 id="姿态估计">姿态估计<a class="anchor" href="#%e5%a7%bf%e6%80%81%e4%bc%b0%e8%ae%a1">#</a></h2>
<p>文章的中心问题, 也就是姿态估计的中心任务, 是如何求出估计后姿态 $\hat{R}$ 的微分, 以便通过积分来实时确定姿态, 同时确保误差 $\tilde{R}$ 最小.</p>
<p>通过上面的运动学分析, 可以得出 $\dot{\hat{R}} = [R_y \Omega]_\times \hat{R}$, 这其中作用于 $\Omega$ 的矩阵为 $R_y$ 而非 $\hat{R}$, 是因为 $\Omega$ 所在的参考系为 ${B}$, 这给了我们设计滤波器方面的一些灵活性.</p>
<p>可以证明, 此时误差 $\tilde{R}$ 恒定
</p>
$$\begin{align}
\dot{\tilde{R}} &= \partial (\hat{R}^T R_y) \\
  &= \dot{\hat{R}}^T R_y + \hat{R}^T \dot{R_y} \\
  &= ([R_y \Omega]_\times \hat{R})^T R_y + \hat{R}^T [R_y \Omega]_\times R_y \\
  &= \hat{R}^T [R_y \Omega]_\times^T R_y + \hat{R}^T [R_y \Omega]_\times R_y \\
  &= 0
\end{align}$$<p>为了消除误差, 我们通过添加一项关于误差的函数 $\omega := \omega(\tilde{R})$ 来引入负反馈
</p>
$$\dot{\hat{R}} = [R_y \Omega + k_P \omega]_\times \hat{R}$$<p>滤波器设计的核心在于函数 $\omega(\tilde{R})$ 的选取. Mahony 等人提出的方案是
</p>
$$\begin{align}
\sideset{^E}{}\omega &= \mathrm{vex} ~ \mathbb{P}_a(\tilde{R}) \\
\sideset{^A}{}\omega &= \hat{R} ~ \sideset{^E}{}\omega
\end{align}$$<p>如此一来我们有
</p>
$$\begin{align}
& [R_y \Omega + k_P \hat{R} ~ \mathrm{vex} ~ \mathbb{P}_a(\tilde{R})]_\times \\
  =& ~ [R_y \Omega]_\times + k_P [\hat{R} ~ \mathrm{vex} ~ \mathbb{P}_a(\tilde{R})]_\times \\
  =& ~ [R_y \Omega]_\times + k_P \hat{R} [\mathrm{vex} ~ \mathbb{P}_a(\tilde{R})]_\times \hat{R}^T \\
  =& ~ [R_y \Omega]_\times + k_P \hat{R} \mathbb{P}_a(\tilde{R}) \hat{R}^T \\
  =& ~ [R_y \Omega]_\times + k_P \mathbb{P}_a(R_y \hat{R}^T)
\end{align}$$<p>
</p>
$$\dot{\hat{R}} = ([R_y \Omega]_\times + k_P \mathbb{P}_a(R_y \hat{R}^T)) \hat{R}$$<p>可以证明, 引入的负反馈的确使得误差 $\tilde{R}$ 收敛于 $I$.
为了证明这一点, 引入优化变量
$E := \frac{1}{2} |I - \tilde{R}|_F^2 = \mathrm{tr}(I - \tilde{R})$,
对其求导得 $\partial E = \partial ~ \mathrm{tr}(I - \tilde{R}) = -\mathrm{tr} ~ \partial \tilde{R}$. $\tilde{R}$ 的导数如下求得
</p>
$$\begin{align}
\dot{\tilde{R}} &= \partial (\hat{R}^T R_y) \\
  &= \dot{\hat{R}}^T R_y + \hat{R}^T [R_y \Omega]_\times R_y \\
  &= \hat{R}^T ([R_y \Omega]_\times + k_P \mathbb{P}_a(R_y \hat{R}^T))^T R_y + \hat{R}^T [R_y \Omega]_\times R_y \\
  &= - k_P \hat{R}^T \mathbb{P}_a(R_y \hat{R}^T) R_y \\
  &= \frac{1}{2} k_P (I - \tilde{R}^2)
\end{align}$$<p>
于是有
</p>
$$\begin{align}
\partial E &= - \mathrm{tr} ~ \dot{\tilde{R}} \\
  &= - \frac{1}{2} \mathrm{tr} ~ k_P (I - \tilde{R}^2) \\
  &= - \frac{1}{2} k_P ~ \mathrm{tr} (\cos{\theta} - 1) [\hat{n}]_\times^2 \\
  &= - \frac{1}{2} k_P (\cos{\theta} - 1) (-2 \|\hat{n}\|^2) \\
  &= - k_P (1 - \cos{\theta}) \\
  & \leq 0
\end{align}$$<p>
上面证明中用到的旋转矩阵计算公式可以在 <a href="Work/julia/rotation.md">这里</a> 中找到.
当且仅当 $\tilde{R}^2$ 的转角 $\theta = 0, 2\pi$ 时取等号,
即 $\tilde{R}$ 转角为 $0$ 或 $\pi$ 时.
对于转角为 $\pi$ 的特殊情况在论文中做了详细讨论.
我们可以认为, 在 $\tilde{R} \neq I$ 时 $E$ 单调递减, 且有下界 $0$,
于是其必收敛于 $0$, 这样就证明了 $\tilde{R}$ 将收敛于 $I$.</p>
<p>附加上关于陀螺仪偏置 $\mathbf{b}$ 的估计, 我们可以引出<strong>直接互补滤波器</strong>:
</p>
$$\boxed{\begin{align}
\dot{\hat{R}} &= ([R_y (\Omega^y - \hat{b})]_\times + k_P \mathbb{P}_a(R_y \hat{R}^T)) \hat{R} \\
\dot{\hat{b}} &= - k_I \mathrm{vex} ~ \mathbb{P}_a(\tilde{R})
\end{align}}$$<p>其中 $R_y$ 作为系统输入, 来自一个优化问题:
</p>
$$R_y = \arg \underset{R \in SO(3)}{\min} (\lambda_1 \| \mathbf{e}_3 - R \mathbf{v}_a \|^2 + \lambda_2 \| \mathbf{v}_m^* - R \mathbf{v}_m \|^2)$$<p>
考虑到求解此问题的复杂性, 直接互补滤波器并不便于使用.</p>
<p>我们做近似 $\hat{R} \sim R_y$, 这是基于 ${B}$ 与 ${E}$ 通常十分接近的假设. 这样有
</p>
$$\begin{align}
\dot{\hat{R}} &= [\hat{R} \Omega + k_P \omega]_\times \hat{R} \\
  &= ([\hat{R} \Omega]_\times + k_P \mathbb{P}_a(R_y \hat{R}^T)) \hat{R} \\
  &= \hat{R} ([\Omega]_\times + k_P \mathbb{P}_a (\tilde{R}))
\end{align}$$<p>接下来我们确认近似的正确性, 通过计算上式是否收敛来检验:
</p>
$$\begin{align}
\dot{\tilde{R}} &= \dot{\hat{R}}^T R_y + \hat{R}^T \dot{R_y} \\
  &= (\hat{R} ([\Omega]_\times + k_P \mathbb{P}_a (\tilde{R})))^T R_y \
    + \hat{R}^T R_y [\Omega]_\times \\
  &= ([\Omega]_\times + k_P \mathbb{P}_a (\tilde{R}))^T \hat{R}^T R_y \
    + \hat{R}^T R_y [\Omega]_\times \\
  &= - [\Omega]_\times \tilde{R} + k_P \mathbb{P}_a (\tilde{R}^T) \tilde{R} + \tilde{R} [\Omega]_\times \\
  &= - [\Omega]_\times \tilde{R} + \tilde{R} [\Omega]_\times + \frac{k_P}{2} (I - \tilde{R}^2)
\end{align}$$<p>
$\partial E = - \mathrm{tr} ~ \dot{\tilde{R}} = - \frac{1}{2} \mathrm{tr} ~ k_P (I - \tilde{R}^2)$, 与上面直接互补滤波器的结果一致, 于是收敛性也得到保证.</p>
<p>这一结果被称为<strong>被动互补滤波器</strong>:
</p>
$$\boxed{\begin{align}
\dot{\hat{R}} &= \hat{R} ([\Omega^y - \hat{b}]_\times + k_P \mathbb{P}_a (\tilde{R})) \\
\dot{\hat{b}} &= - k_I \mathrm{vex} ~ \mathbb{P}_a(\tilde{R})
\end{align}}$$<p>因为滤波器内含有 $\tilde{R}$, 包含对 $R_y$ 的依赖, 于是使用同样受到限制.</p>
<h2 id="显式互补滤波器">显式互补滤波器<a class="anchor" href="#%e6%98%be%e5%bc%8f%e4%ba%92%e8%a1%a5%e6%bb%a4%e6%b3%a2%e5%99%a8">#</a></h2>
<p>在被动互补滤波器的基础上, 我们消除对 $R_y$ 的显式依赖, 通过直接使用方向向量来构筑滤波器.
这被称为<em>显式互补滤波器</em>.</p>
<p>假如我们有 $n$ 组可以确定的方向, 它们可以来自重力方向以及磁场方向等,
记为 $\mathbf{v}_{0i} \in {A}$, 另外要求它们是归一化的.
于是我们可以得到在 ${B}$ 中的方向 $\mathbf{v}<em>i = R^T \mathbf{v}</em>{0i}$,
以及 ${E}$ 中的方向 $\hat{\mathbf{v}}<em>i = \hat{R}^T \mathbf{v}</em>{0i}$.
我们不妨令第 $i$ 个估计方向与实际方向的误差为 $E_i = 1 - \mathbf{v}_i^T \hat{\mathbf{v}}_i$.
另外, 引入权重 $k_i$ 表征特定参考方向的不确定性, 若其置信度较低, 则 $k_i$ 值应该较小, 以此减小此方向引入的误差.
综上, 令此时的总误差为
</p>
$$\begin{align}
E' &= \sum_i k_i E_i \\
  &= \sum_i k_i (1 - \mathbf{v}_i^T \hat{\mathbf{v}}_i) \\
  &= \sum_i k_i - \sum_i k_i \mathbf{v}_i^T \hat{\mathbf{v}}_i
\end{align}$$<p>
其中
</p>
$$\begin{align}
\sum_i k_i \mathbf{v}_i^T \hat{\mathbf{v}}_i &= \
  \mathrm{tr} \sum_i k_i \mathbf{v}_i^T \hat{\mathbf{v}}_i \\
  &= \mathrm{tr} \sum_i k_i \hat{\mathbf{v}}_i \mathbf{v}_i^T \\
  &= \mathrm{tr} \sum_i k_i (\hat{R}^T \mathbf{v}_{0i}) (R^T \mathbf{v}_{0i})^T \\
  &= \mathrm{tr} \sum_i k_i \hat{R}^T \mathbf{v}_{0i} \mathbf{v}_{0i}^T R \\
  &= \mathrm{tr} ~ \hat{R}^T R \sum_i k_i R^T \mathbf{v}_{0i} \mathbf{v}_{0i}^T R \\
  &= \mathrm{tr} ~ \tilde{R} M, ~~ M = R^T (\sum_i k_i \mathbf{v}_{0i} \mathbf{v}_{0i}^T) R
\end{align}$$<p>从上面也可以看出 $\tilde{R} M = \sum_i k_i \hat{\mathbf{v}}_i \mathbf{v}_i^T$.</p>
<p>此时 $E&rsquo; = \sum_i k_i - \mathrm{tr} ~ \tilde{R} M$ 的形态已经与上述
$E = \mathrm{tr} (I - \tilde{R}) = 3 - \mathrm{tr} ~ \tilde{R}$
极为相似.
仿照 $\sideset{^E}{}\omega(\tilde{R}) = \mathrm{vex} ~ \mathbb{P}<em>a(\tilde{R})$, 我们令
$$\begin{align}
\omega &= \mathrm{vex} ~ \mathbb{P}_a (\tilde{R} M) \\
  &= \frac{1}{2} \mathrm{vex} (\tilde{R} M - M^T \tilde{R}^T) \\
  &= \frac{1}{2} \mathrm{vex} \sum_i k_i (\hat{\mathbf{v}}_i \mathbf{v}_i^T - \mathbf{v}_i \hat{\mathbf{v}}_i^T) \\
  &= \frac{1}{2} \mathrm{vex} \sum_i k_i [\mathbf{v}_i \times \hat{\mathbf{v}}_i]_\times \\
  &= \frac{1}{2} \sum_i k_i ~ \mathbf{v}_i \times \hat{\mathbf{v}}_i
\end{align}$$
用到的引理
$\mathbf{a} \mathbf{b}^T - \mathbf{b} \mathbf{a}^T = [\mathbf{b} \times \mathbf{a}]</em>\times$
我们不再证明.</p>
<p>将其代入被动互补滤波器, 就得到了<strong>显式互补滤波器</strong>:
</p>
$$\boxed{\begin{align}
\dot{\hat{R}} &= \hat{R} ([\Omega^y - \hat{b}]_\times + k_P [\omega]_\times) \\
\dot{\hat{b}} &= - k_I \omega \\
\text{where} \\
\omega &= \sum_i \frac{k_i}{2} ~ \mathbf{v}_i \times \hat{\mathbf{v}}_i \\
\hat{\mathbf{v}}_i &= \hat{R}^T ~ \mathbf{v}_{0i}
\end{align}}$$<h2 id="四元数滤波运动学">四元数滤波运动学<a class="anchor" href="#%e5%9b%9b%e5%85%83%e6%95%b0%e6%bb%a4%e6%b3%a2%e8%bf%90%e5%8a%a8%e5%ad%a6">#</a></h2>
<p>单位四元数可用于描述旋转, 它们构成群 $S^3$,
并且与 $SO(3)$ 之间存在一个自然的群同态.
其中的元素表示为 $q = [\cos{\frac{\Omega}{2}}, \sin{\frac{\Omega}{2}} ~ \hat{\mathbf{n}}] \in S^3$,
它表示了绕单位轴 $\hat{\mathbf{n}}$ 旋转 $\Omega$.</p>
<p>将旋转作用在向量上这一动作用四元数表示为 $q \mathbf{v} q^<em>$,
其中 $q^</em>$ 表示 $q$ 的共轭.
特殊地, 旋转矩阵的转置对应于四元数的共轭, 它们都是因为这一操作在各自的约束下与取逆等价.
注意, 这里的向量 $\mathbf{\Omega}$ 都是纯虚四元数
$\mathbf{\Omega} = \Omega_x \mathrm{i} + \Omega_y \mathrm{j} + \Omega_z \mathrm{k}$, 下同.</p>
<p>另外, 可以得到 $S^3$ 中元素的李代数指数表示 $q = \exp{\frac{\Omega}{2} \hat{\mathbf{n}} t} = \exp{\mathbf{\Omega} t/2}$.
于是运动学方程为
</p>
$$\dot{q} = q \frac{\mathbf{\Omega}}{2}$$<p>注意到显式互补滤波器
$\dot{\hat{R}} = \hat{R} ~ [\Omega^y - \hat{b} + k_P \omega]<em>\times$
与矩阵运动学
$\dot{R} = R ~ [\Omega]</em>\times$
之间的联系, <strong>基于四元数运动学的显式互补滤波器</strong>可以被自然地导出:
</p>
$$\boxed{\begin{align}
\dot{\hat{q}} &= \frac{1}{2} \hat{q} ~ (\Omega^y - \hat{b} + k_P \omega) \\
\dot{\hat{b}} &= - k_I \omega \\
\text{where} \\
\omega &= \sum_i \frac{k_i}{2} ~ \mathbf{v}_i \times \hat{\mathbf{v}}_i \\
\hat{\mathbf{v}}_i &= \hat{q}^* ~ \mathbf{v}_{0i} ~ \hat{q}
\end{align}}$$<p>定义四元数乘法使用的 Graßmann 积也摘录在此:
对于四元数 $q_1 = [u_1, \mathbf{v}_1]$, $q_2 = [u_2, \mathbf{v}_2]$,
</p>
$$q_1 q_2 = [u_1 u_2 - \mathbf{v}_1 \cdot \mathbf{v}_2, ~ u_2 \mathbf{v}_1 + u_1 \mathbf{v}_2 + \mathbf{v}_1 \times \mathbf{v}_2]$$<h2 id="后记">后记<a class="anchor" href="#%e5%90%8e%e8%ae%b0">#</a></h2>
<p>就本文所介绍的三种滤波器以及一种变种来说, 通常而言使用最广泛的是显式互补滤波器及其四元数版本, 通称 Mahony 互补滤波器也是指这两者.</p>
<p>在实际使用中, 对于传感器的数据进行预处理是十分有必要的, 例如剔除加速度计的高频分量来获得稳定的重力方向.
此外, 在估计过程中动态调整不同传感器方向的权重也是规避误差的有效方法.</p>
<p>当已知方向数量在 $2$ 个及以上时, 滤波器在理论上是稳定的.
当参考方向只有 $1$ 个, 例如只有重力方向时, 在正交方向会产生漂移, 此时这一方向上的估计全部依赖于角速度输入.
当没有参考方向时, 滤波器完全退化为对角速度积分.</p>
<p>滤波器给出的输出为估计姿态与偏置的导数, 通过积分可以得到姿态与偏置.
在实际应用中, 离散化的积分因为步长精度原因, 不可避免地会引入截断误差.
此时需要对位姿进行优化来满足约束.
对于矩阵运动学, 优化过程归结为求解<em>最近旋转矩阵</em>问题, 也就是将稍有偏差的矩阵映射为严格的 $SO(3)$ 中的元素.
对于四元数运动学, 因为四元数只有 $4$ 个自由度, 冗余的自由度不足以优化旋转所需的 $3$ 个自由度, 我们只能选取一个参量来进行优化.
通常而言选择约束转角, 可以证明, 这等价于对四元数进行归一化.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>R. Mahony, T. Hamel, and J.-M. Pflimlin, &ldquo;Nonlinear Complementary Filters on the Special Orthogonal Group&rdquo;, <em>IEEE Transactions on Automatic Control</em>, vol. 53, no. 5, pp. 1203–1217, May 2008, doi: <a href="https://doi.org/10.1109/TAC.2008.923738">10.1109/TAC.2008.923738</a>.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</article>
 
      




  <div class="flex flex-wrap justify-between">
    <div class="flex align-center text-sm text-muted">
      
      <span class="overline" style="font-style:italic;">Last updated: June 30, 2025</span>
    </div>
  </div>




      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">

<div>

</div>

<div>

</div>

</div>





  
  
  
  <div class="flex flex-wrap justify-between">
    <span>
    
      <a href="/docs/c3e9f1/" class="flex align-center">
        <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
        <span>ESP32 环境配置与开发</span>
      </a>
    
    </span>
    <span>
    
      <a href="/docs/243281/" class="flex align-center">
        <span>异步非阻塞串口数据接收</span>
        <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
      </a>
    
    </span>
  </div>
  


 
        
  
  <div class="book-comments">

</div>
  
 
        
        
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
  <aside class="book-toc">
    <div class="book-toc-content">
      
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#符号约定与传感器数据建模">符号约定与传感器数据建模</a>
      <ul>
        <li><a href="#陀螺仪">陀螺仪</a></li>
        <li><a href="#加速度计">加速度计</a></li>
        <li><a href="#磁力计">磁力计</a></li>
      </ul>
    </li>
    <li><a href="#刚体运动学">刚体运动学</a></li>
    <li><a href="#姿态估计">姿态估计</a></li>
    <li><a href="#显式互补滤波器">显式互补滤波器</a></li>
    <li><a href="#四元数滤波运动学">四元数滤波运动学</a></li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav>



    </div>
  </aside>
  
 
  </main>

  
</body>
</html>




















